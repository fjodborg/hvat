name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      # - experimental  # Uncomment when experimental branch exists
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-main:
    runs-on: self-hosted
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Build WASM (main)
        run: |
          rustup target add wasm32-unknown-unknown
          cargo fmt --all -- --check
          # TODO, This is a workdaround and should get a proper fix (Generates version file)
          cargo build
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          trunk build --release --public-url "/${REPO_NAME}/"

      - name: Fix PWA paths
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          sed -i "s|'/'|'/${REPO_NAME}/'|g" dist/sw.js
          sed -i "s|'/index.html'|'/${REPO_NAME}/index.html'|g" dist/sw.js
          sed -i "s|'/manifest.json'|'/${REPO_NAME}/manifest.json'|g" dist/sw.js
          sed -i "s|'/icons/|'/${REPO_NAME}/icons/|g" dist/sw.js
          sed -i "s|\"start_url\": \"/\"|\"start_url\": \"/${REPO_NAME}/\"|g" dist/manifest.json
          sed -i "s|\"scope\": \"/\"|\"scope\": \"/${REPO_NAME}/\"|g" dist/manifest.json
          sed -i "s|href=\"manifest.json\"|href=\"/${REPO_NAME}/manifest.json\"|g" dist/index.html
          sed -i "s|href=\"icons/|href=\"/${REPO_NAME}/icons/|g" dist/index.html

      - name: Upload main artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-main
          path: dist
          retention-days: 1

  # build-experimental:
  #   runs-on: self-hosted
  #   continue-on-error: true
  #   steps:
  #     - name: Checkout experimental
  #       uses: actions/checkout@v4
  #       with:
  #         ref: experimental
  #
  #     - name: Build WASM (experimental)
  #       run: |
  #         rustup target add wasm32-unknown-unknown
  #         cargo fmt --all -- --check
  #         REPO_NAME="${GITHUB_REPOSITORY#*/}"
  #         trunk build --release --public-url "/${REPO_NAME}/experimental/"
  #
  #     - name: Fix PWA paths
  #       run: |
  #         REPO_NAME="${GITHUB_REPOSITORY#*/}"
  #         BASE="/${REPO_NAME}/experimental"
  #         sed -i "s|'/'|'${BASE}/'|g" dist/sw.js
  #         sed -i "s|'/index.html'|'${BASE}/index.html'|g" dist/sw.js
  #         sed -i "s|'/manifest.json'|'${BASE}/manifest.json'|g" dist/sw.js
  #         sed -i "s|'/icons/|'${BASE}/icons/|g" dist/sw.js
  #         sed -i "s|\"start_url\": \"/\"|\"start_url\": \"${BASE}/\"|g" dist/manifest.json
  #         sed -i "s|\"scope\": \"/\"|\"scope\": \"${BASE}/\"|g" dist/manifest.json
  #         sed -i "s|href=\"manifest.json\"|href=\"${BASE}/manifest.json\"|g" dist/index.html
  #         sed -i "s|href=\"icons/|href=\"${BASE}/icons/|g" dist/index.html
  #
  #     - name: Upload experimental artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: dist-experimental
  #         path: dist
  #         retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: [build-main]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download main artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-main
          path: site

      # - name: Download experimental artifact
      #   uses: actions/download-artifact@v4
      #   continue-on-error: true
      #   with:
      #     name: dist-experimental
      #     path: site/experimental

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
